<!doctype html>
<html>
  <head>
    <title>Desenvolvimento Web com Ajax</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-alpha3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-CuOF+2SnTUfTwSZjCXf01h7uYhfOBuxIhGKPbfEJ3+FqH/s6cIFN9bGr1HmAg4fQ"
      crossorigin="anonymous"
    >
    <style>
      body {
        padding-top: 2rem;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h3>Preenchendo o endereço com Ajax</h3>

      <form class="row g-3">
        <div>
          <label for="cep" class="form-label"
            >Informe o CEP no formato xxxxx-xxx (Ex. 38400-100,
            38400-200)</label
          >
          <input type="text" class="form-control" id="cep" name="cep">
        </div>
        <div>
          <label for="rua" class="form-label">Rua:</label>
          <input type="text" class="form-control" id="rua" name="rua">
        </div>
        <div>
          <label for="bairro" class="form-label">Bairro:</label>
          <input type="text" class="form-control" id="bairro" name="bairro">
        </div>
        <div>
          <label for="cidade" class="form-label">Cidade:</label>
          <input type="text" class="form-control" id="cidade" name="cidade">
        </div>
      </form>
    </div>

    <script>
      // Define a funcao que será chamada em cada tecla clicada no input.





         // Apenas verifica os CEP se estiver completo.
        if (cep.length != 9)
          return;

        // Cria o objeto XMLHttpRequest
        let xhr = new XMLHttpRequest();

        // Abre o script PHP com o método GET de forma assíncrona.
        xhr.open("GET", "busca-endereco.php?cep=" + cep);

      // Define o tipo de resposta como json para melhor tratar os dados
        xhr.responseType = 'json';

        // Define a funcao que será realizada no retorno do servidor
        xhr.onload = function () {
        // Verificacao se o CEP foi encontrado: deve retornar status 200
          if (xhr.status != 200 || xhr.response === null) {
            console.log("A resposta não pode ser obtida ");
            console.log(xhr.status);
            return;
          }


        // Define um objeto endereco com a resposta em JSON do objeto XMLHttpRequest
        const endereco = xhr.response;

        // Acha o elemento form e insere os respectivos valores dos inputs devolvidos pelo método.
        let form = document.querySelector("form");
        form.rua.value = endereco.rua;
        form.bairro.value = endereco.bairro;
        form.cidade.value = endereco.cidade;
        }

        // Define funcao de erro
        xhr.onerror = function () {
          console.error("Erro de rede - requisição não finalizada");
        };

        // Envia a requisicao HTTP de forma assincrona.
        xhr.send();
      }

      const inputCep = document.querySelector("#cep");
      inputCep.onkeyup = () => buscaEndereco(inputCep.value);
    </script>
  </body>
</html>
