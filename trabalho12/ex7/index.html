<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8">
    <title>Mini Blackjack</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    >
    <style>
      body {
        background-color: #2c3e50;
        color: white;
      }
      .game-area {
        max-width: 600px;
        margin: 2rem auto;
      }
      .cards {
        display: flex;
        gap: 10px;
        margin: 1rem 0;
      }
      .cards img {
        height: 120px;
        border-radius: 6px;
      }
      .btn-area {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 1rem;
      }
    </style>
  </head>
  <body>
    <div class="container game-area text-center">
      <h1 class="mb-4">Mini Blackjack</h1>
      <p class="alert alert-info fs-6">
        Bem-vindo ao <strong>Mini Blackjack</strong>! Puxe cartas e tente chegar
        o mais próximo de <strong>21</strong> sem estourar. O Ás vale 11 ou 1,
        conforme for melhor. O dealer terá uma carta visível e outra escondida.
        Pare quando quiser e veja se você vence!
      </p>
      <div>
        <h4>Dealer (<span id="dealer-points">?</span> pontos)</h4>
        <div id="dealer-cards" class="cards"></div>
      </div>

      <div>
        <h4>Você (<span id="player-points">0</span> pontos)</h4>
        <div id="player-cards" class="cards"></div>
      </div>

      <div class="btn-area">
        <button id="btn-hit" class="btn btn-success">Puxar Carta</button>
        <button id="btn-stand" class="btn btn-warning">Parar</button>
        <button id="btn-reset" class="btn btn-danger">Reiniciar</button>
      </div>

      <div id="feedback" class="mt-3 fs-5"></div>
    </div>

    <script>
      let deckId = "";
      let playerCards = [];
      let dealerCards = [];
      let hiddenCard = null; // carta escondida do dealer
      let playerDrawCount = 0;

      const dealerCardsDiv = document.getElementById("dealer-cards");
      const playerCardsDiv = document.getElementById("player-cards");
      const dealerPointsEl = document.getElementById("dealer-points");
      const playerPointsEl = document.getElementById("player-points");
      const feedback = document.getElementById("feedback");

      async function initDeck() {
        const res = await fetch(
          "https://deckofcardsapi.com/api/deck/new/shuffle/?deck_count=1",
        );
        const data = await res.json();
        deckId = data.deck_id;
      }

      async function drawCard() {
        const res = await fetch(
          `https://deckofcardsapi.com/api/deck/${deckId}/draw/?count=1`,
        );
        const data = await res.json();
        return data.cards[0];
      }

      function calculatePoints(cards) {
        let sum = 0;
        let aces = 0;

        for (let card of cards) {
          if (["KING", "QUEEN", "JACK"].includes(card.value)) sum += 10;
          else if (card.value === "ACE") {
            sum += 11;
            aces++;
          } else {
            sum += parseInt(card.value);
          }
        }

        while (sum > 21 && aces > 0) {
          sum -= 10; // ACE vale 1
          aces--;
        }
        return sum;
      }

      function updateDisplay() {
        dealerCardsDiv.innerHTML = dealerCards
          .map((c, i) => {
            if (i === 1 && hiddenCard)
              return `<img src="https://deckofcardsapi.com/static/img/back.png">`;
            return `<img src="${c.image}">`;
          })
          .join("");

        playerCardsDiv.innerHTML = playerCards
          .map((c) => `<img src="${c.image}">`)
          .join("");

        dealerPointsEl.textContent = hiddenCard
          ? "?"
          : calculatePoints(dealerCards);
        playerPointsEl.textContent = calculatePoints(playerCards);
      }

      function checkWinner() {
        const playerPoints = calculatePoints(playerCards);
        if (playerPoints > 21) {
          feedback.innerHTML = `<div class="alert alert-danger">Você estourou! Dealer vence.</div>`;
          disableButtons();
        } else if (playerPoints === 21) {
          feedback.innerHTML = `<div class="alert alert-success">Blackjack! Você vence!</div>`;
          disableButtons();
        }
      }

      function disableButtons() {
        document.getElementById("btn-hit").disabled = true;
        document.getElementById("btn-stand").disabled = true;
      }

      async function dealerTurn() {
        if (hiddenCard) {
          dealerCards[1] = hiddenCard;
          hiddenCard = null;
        }

        let dealerPoints = calculatePoints(dealerCards);
        updateDisplay();

        while (dealerPoints < 17) {
          const card = await drawCard();
          dealerCards.push(card);
          dealerPoints = calculatePoints(dealerCards);
          updateDisplay();
        }

        const playerPoints = calculatePoints(playerCards);

        if (dealerPoints > 21 || dealerPoints < playerPoints) {
          feedback.innerHTML = `<div class="alert alert-success">Você vence!</div>`;
        } else if (dealerPoints === playerPoints) {
          feedback.innerHTML = `<div class="alert alert-warning">Empate!</div>`;
        } else {
          feedback.innerHTML = `<div class="alert alert-danger">Dealer vence!</div>`;
        }
      }

      async function hit() {
        const card = await drawCard();
        playerCards.push(card);
        playerDrawCount++;

        if (playerDrawCount === 1) {
          const dealerCard1 = await drawCard();
          dealerCards.push(dealerCard1);
        }

        if (playerDrawCount === 2) {
          hiddenCard = await drawCard();
          dealerCards.push(hiddenCard);
        }

        updateDisplay();
        checkWinner();
      }

      async function stand() {
        disableButtons();
        await dealerTurn();
      }

      function resetGame() {
        playerCards = [];
        dealerCards = [];
        hiddenCard = null;
        playerDrawCount = 0;
        feedback.innerHTML = "";
        document.getElementById("btn-hit").disabled = false;
        document.getElementById("btn-stand").disabled = false;
        dealerPointsEl.textContent = "?";
        playerPointsEl.textContent = "0";
        dealerCardsDiv.innerHTML = "";
        playerCardsDiv.innerHTML = "";
      }

      document.getElementById("btn-hit").addEventListener("click", hit);
      document.getElementById("btn-stand").addEventListener("click", stand);
      document.getElementById("btn-reset").addEventListener("click", resetGame);

      window.onload = initDeck;
    </script>
  </body>
</html>
