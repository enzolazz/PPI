<!doctype html>
<html>
  <head>
    <title>Desenvolvimento Web com Ajax</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-alpha3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-CuOF+2SnTUfTwSZjCXf01h7uYhfOBuxIhGKPbfEJ3+FqH/s6cIFN9bGr1HmAg4fQ"
      crossorigin="anonymous"
    >
    <style>
      body {
        padding-top: 2rem;
      }

      h3 {
        margin-bottom: 2rem;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h3>Preenchendo o endereço com Ajax</h3>

      <form class="row g-3">
        <div>
          <label for="cep" class="form-label"
            >Informe o CEP no formato xxxxx-xxx (Ex. 38400-100)</label
          >
          <input type="text" class="form-control" id="cep" name="cep">
        </div>
        <div>
          <label for="rua" class="form-label">Rua:</label>
          <input type="text" class="form-control" id="rua" name="rua">
        </div>
        <div>
          <label for="bairro" class="form-label">Bairro:</label>
          <input type="text" class="form-control" id="bairro" name="bairro">
        </div>
        <div>
          <label for="cidade" class="form-label">Cidade:</label>
          <input type="text" class="form-control" id="cidade" name="cidade">
        </div>
      </form>
    </div>

    <script>
      async function buscaEndereco(cep) {
        // Verifica se o CEP informado possui exatamente 9 caracteres
        // (formato comum: 00000-000). Caso contrário, a função é encerrada.
        if (cep.length != 9) return;

        try {
          // Realiza uma requisição assíncrona para o arquivo PHP,
          // enviando o CEP como parâmetro na URL.
          const response = await fetch("busca-endereco-bd.php?cep=" + cep);
          // response.status = 200
          // response.body nao contém os dados do endereco, a propriedade
          // é um ReadableStrem, ou seja, precisa ser consumida usando um método
          // para transformá-la em JSON.

          // Caso a resposta não seja bem-sucedida (status fora da faixa 200-299),
          // obtém o texto de erro retornado pelo servidor e lança uma exceção.
          if (!response.ok) {
            errorMessage = await response.text();
            throw new Error(response.statusText + errorMessage);
          }

          // Se a resposta for válida, converte os dados recebidos em JSON,
          // resultando em um objeto contendo as informações do endereço.
          const endereco = await response.json();

          // Seleciona o elemento <form> presente na página.
          const form = document.querySelector("form");

          // Preenche automaticamente os campos do formulário com os dados
          // retornados pelo servidor.
          form.rua.value = endereco.logradouro;
          form.bairro.value = endereco.bairro;
          form.cidade.value = endereco.cidade;
        } catch (e) {
          // Em caso de erro em qualquer etapa (requisição, conversão ou preenchimento),
          // o erro é exibido no console para fins de depuração.
          console.error(e);
          return;
        }
      }

      window.onload = function () {
        const inputCep = document.querySelector("#cep");
        inputCep.onkeyup = () => buscaEndereco(inputCep.value);
      };
    </script>
  </body>
</html>
